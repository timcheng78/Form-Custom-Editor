/*! @preserve
 * bstreeview.js
 * Version: 1.2.0
 * Authors: Sami CHNITER <sami.chniter@gmail.com>
 * Copyright 2020
 * License: Apache License 2.0
 *
 * Project: https://github.com/chniter/bstreeview
 */
; (function ($, window, document, undefined) {
    "use strict"
    /**
     * Default bstreeview  options.
     */
    var pluginName = "bstreeview",
        defaults = {
            expandIcon: 'bi bi-caret-down-fill',
            collapseIcon: 'bi bi-caret-right-fill',
            indent: 1.25,
            parentsMarginLeft: '1.25rem',
            openNodeLinkOnNewTab: true

        }
    /**
     * bstreeview HTML templates.
     */
    var templates = {
        treeview: '<div class="bstreeview"></div>',
        treeviewItem: '<div role="treeitem" class="list-group-item" data-toggle="collapse" draggable="true"></div>',
        treeviewGroupItem: '<div role="group" class="list-group collapse" id="itemid"></div>',
        treeviewItemStateIcon: '<i class="state-icon"></i>',
        treeviewItemIcon: '<i class="item-icon"></i>',
        treeviewInformation: '<i class="float-right bi bi-info-square"></i>'
    }
    /**
     * BsTreeview Plugin constructor.
     * @param {*} element 
     * @param {*} options 
     */
    function bstreeView(element, options) {
        this.element = element
        this.itemIdPrefix = element.id + "-item-"
        this.settings = $.extend({}, defaults, options)
        this.init()
    }
    /**
     * Avoid plugin conflict.
     */
    $.extend(bstreeView.prototype, {
        /**
         * bstreeview intialize.
         */
        init: function () {
            this.tree = []
            this.nodes = []
            // Retrieve bstreeview Json Data.
            if (this.settings.data) {
                if (this.settings.data.isPrototypeOf(String)) {
                    this.settings.data = $.parseJSON(this.settings.data)
                }
                this.tree = $.extend(true, [], this.settings.data)
                delete this.settings.data
            }
            // Set main bstreeview class to element.
            this.element.classList.add('bstreeview')
            this.initData({ nodes: this.tree })
            var _this = this
            this.build($(this.element), this.tree, 0)
            // Update angle icon on collapse
            $(this.element).off('click')
            $(this.element).on('click', '.list-group-item', function (e) {
                $('.state-icon', this)
                    .toggleClass(_this.settings.expandIcon)
                    .toggleClass(_this.settings.collapseIcon)
                // navigate to href if present
                if (e.target.hasAttribute('href')) {
                    if (_this.settings.openNodeLinkOnNewTab) {
                        window.open(e.target.getAttribute('href'), '_blank')
                    }
                    else {
                        window.location = e.target.getAttribute('href')
                    }
                }
            })
        },
        /**
         * Initialize treeview Data.
         * @param {*} node 
         */
        initData: function (node) {
            if (!node.nodes) return
            var parent = node
            var _this = this
            $.each(node.nodes, function checkStates(index, node) {

                node.nodeId = _this.nodes.length
                node.parentId = parent.nodeId
                _this.nodes.push(node)

                if (node.nodes) {
                    _this.initData(node)
                }
            })
        },
        /**
         * Build treeview.
         * @param {*} parentElement 
         * @param {*} nodes 
         * @param {*} depth 
         */
        build: function (parentElement, nodes, depth) {
            var _this = this
            // Calculate item padding.
            var leftPadding = _this.settings.parentsMarginLeft

            if (depth > 0) {
                leftPadding = (_this.settings.indent + depth * _this.settings.indent).toString() + "rem;"
            }
            depth += 1
            // Add each node and sub-nodes.
            $.each(nodes, function addNodes(id, node) {
                // Main node element.
                var treeItem = $(templates.treeviewItem)
                    .attr('data-target', "#" + _this.itemIdPrefix + node.nodeId)
                    .attr('style', 'padding-left:' + leftPadding)
                    .attr('aria-level', depth)
                // 元件編號若有則直接讀取元件編號並賦予對應需求
                if (node._seq !== undefined) $(treeItem).attr('data-seq', node._seq)
                // Set Expand and Collapse icones.
                if (node.nodes && node.nodes.length > 0) {
                    var treeItemStateIcon = $(templates.treeviewItemStateIcon)
                        .addClass(_this.settings.collapseIcon)
                    treeItem.append(treeItemStateIcon)
                }
                // set node icon if exist.
                if (node.icon) {
                    var treeItemIcon = $(templates.treeviewItemIcon)
                        .addClass(node.icon)
                    treeItem.append(treeItemIcon)
                }
                // Set node type icon if exist.
                if (node.type) {
                    var treeItemIcon = $(templates.treeviewItemIcon)
                    switch (node.type) {
                        case 'checkbox':
                            treeItemIcon.addClass('bi bi-check2-square')
                            break
                        case 'radio':
                            treeItemIcon.addClass('bi bi-ui-radios-grid')
                            break
                        case 'input':
                        case 'text':
                            treeItemIcon.addClass('bi bi-input-cursor')
                            break
                        case 'textarea':
                            treeItemIcon.addClass('bi bi-fonts')
                            break
                        case 'datetime':
                            treeItemIcon.addClass('bi bi-calendar')
                            break
                        case 'select':
                            treeItemIcon.addClass('bi bi-card-list')
                            break
                        case 'addressTW':
                            treeItemIcon.addClass('bi bi-house-door')
                            break
                        case 'group':
                            treeItemIcon.addClass('bi bi-collection')
                            break
                        case 'csCanvas':
                            treeItemIcon.addClass('bi bi-person-fill')
                            break
                        case 'evaluationTime':
                            treeItemIcon.addClass('bi bi-calendar')
                            break
                        case 'superLink':
                            treeItemIcon.addClass('bi bi-link-45deg')
                            break
                        case 'iframe':
                            treeItemIcon.addClass('bi bi-laptop')
                            break
                        case 'table':
                            treeItemIcon.addClass('bi bi-border-all')
                            break
                        case 'form':
                            treeItemIcon.addClass('bi bi-file-earmark')
                            break
                        case 'folder':
                            treeItemIcon.addClass('bi bi-folder')
                            break
                        case 'cloud':
                            treeItemIcon.addClass('bi bi-cloud')
                            break
                        case 'button':
                            treeItemIcon.addClass('bi bi-menu-button')
                            break
                        case 'file':
                            treeItemIcon.addClass('bi bi-file-earmark-arrow-up')
                            break
                        case 'totalScore':
                            treeItemIcon.addClass('bi bi-calculator')
                            break
                        case 'schema':
                            treeItemIcon.addClass('bi bi-server')
                            break
                        case 'column':
                            treeItemIcon.addClass('bi bi-table')
                            break
                        case 'item':
                            treeItemIcon.addClass('bi bi-file-earmark-code')
                    }
                    treeItem.attr('data-node-type', node.type)
                    treeItem.append(treeItemIcon)
                }
                // Set node structure.
                if (node.structure && Object.keys(node.structure).length > 0) {
                    treeItem.attr('data-structure', JSON.stringify(node.structure))
                }
                // Set node information
                if (node.information) {
                    treeItem.attr('data-information', JSON.stringify(node.information))
                }
                // Set draggable if need.
                if (node.draggable === false) {
                    treeItem.attr('draggable', node.draggable)
                }
                // Set node value.
                if (node.value) {
                    treeItem.attr('value', node.value)
                }
                // Set node onclick event if need.
                if (node.onclick) {
                    treeItem.attr('onclick', node.onclick)
                }
                // Set node oncontextmenu event if need.
                if (node.oncontextmenu) {
                    treeItem.attr('oncontextmenu', node.oncontextmenu)
                }
                // Set node Text.
                treeItem.append(node.text)
                if (node.description) {
                    treeItem.append(`(${ node.description })`)
                    treeItem.attr('description', node.description)
                }
                // Set default.
                treeItem.attr('data-default', true)
                if (node.default === false) {
                    treeItem.attr('data-default', node.default)
                }
                // Reset node href if present
                if (node.href) {
                    treeItem.attr('href', node.href)
                }
                // Add class to node if present
                if (node.class) {
                    treeItem.addClass(node.class)
                }
                // Add custom id to node if present
                if (node.id) {
                    treeItem.attr('id', node.id)
                }
                if (node.hide !== undefined) {
                    if (node.hide) treeItem.hide()
                    else treeItem.show()
                }
                if (node.type !== 'form' &&
                    node.type !== 'cloud' &&
                    node.type !== 'folder' &&
                    node.structure && Object.keys(node.structure).length > 0) {
                    let treeInformation = $(templates.treeviewInformation)
                    let beanStructure = node.structure
                    try {
                        beanStructure = JSON.parse(beanStructure)
                    } catch (e) { }
                    const ele = beanStructure.createElemental()
                    const div = document.createElement('div')
                    $(div).append(ele[0])
                    try {
                        generateStructureBean(div)
                        treeItem.append(treeInformation)
                        treeInformation.hover(
                            function() {
                                CreateUtils.createToolTip({target: treeInformation, content: $(ele[0].outerHTML)[0]})
                            },
                            function() {
                                SharedUtils.removeToolTip()
                            }
                        )
                    } catch (e) { }
                }
                // add parent node
                if (parentElement.attr('id')) {
                    const parent = $(`[data-target="#${ parentElement.attr('id') }"]`)
                    if (parent.length > 0) {
                        let parentNode = parent.attr('data-node-parent') || ''
                        if (parentNode.length > 0) parentNode += '.'
                        parentNode += `${ parent.attr('value') }`
                        treeItem.attr('data-node-parent', `${ parentNode }`)
                        treeItem.attr('id', `${ parentNode }.${ node.value }`)
                    }
                }
                // Attach node to parent.
                parentElement.append(treeItem)
                // Build child nodes.
                if (node.nodes) {
                    // Node group item.
                    var treeGroup = $(templates.treeviewGroupItem)
                        .attr('id', _this.itemIdPrefix + node.nodeId)
                    parentElement.append(treeGroup)
                    _this.build(treeGroup, node.nodes, depth)
                }
            })
        }
    })

    // A really lightweight plugin wrapper around the constructor,
    // preventing against multiple instantiations
    $.fn[pluginName] = function (options) {
        return this.each(function () {
            if (!$.data(this, "plugin_" + pluginName)) {
                $.data(this, "plugin_" +
                    pluginName, new bstreeView(this, options))
            }
        })
    }
})(jQuery, window, document)